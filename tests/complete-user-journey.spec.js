const { test, expect } = require('@playwright/test');

test('ì™„ì „í•œ ì‚¬ìš©ì ì—¬ì •: íšŒì›ê°€ì… â†’ ë¡œê·¸ì¸ â†’ ê¸€ ì‘ì„± â†’ ë¡œê·¸ì•„ì›ƒ', async ({ page }) => {
  const uniqueId = Date.now().toString().slice(-6);
  const testUser = {
    username: `test${uniqueId}`,
    email: `test${uniqueId}@gmail.com`,
    password: 'password123!'
  };
  
  const testPost = {
    title: `ğŸš€ Claude AI ìë™ í…ŒìŠ¤íŠ¸ í¬ìŠ¤íŠ¸ ${uniqueId}`,
    content: `ì•ˆë…•í•˜ì„¸ìš”! ì´ê²ƒì€ Claude Codeê°€ Playwrightë¥¼ ì´ìš©í•´ ìë™ìœ¼ë¡œ ì‘ì„±í•œ í…ŒìŠ¤íŠ¸ ê¸€ì…ë‹ˆë‹¤.

ğŸ“… **ìƒì„± ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
ğŸ¤– **ì‘ì„±ì**: Claude AI (Playwright ìë™í™”)
ğŸ¯ **í…ŒìŠ¤íŠ¸ ëª©ì **: ì „ì²´ ì‚¬ìš©ì í”Œë¡œìš° ê²€ì¦

âœ¨ **í™•ì¸ëœ ê¸°ëŠ¥ë“¤**:
- âœ… íšŒì›ê°€ì… ì‹œìŠ¤í…œ
- âœ… ìë™ í”„ë¡œí•„ ìƒì„±
- âœ… ë¡œê·¸ì¸ ê¸°ëŠ¥  
- âœ… ê¸€ ì‘ì„± ì‹œìŠ¤í…œ
- âœ… ë©”ì¸ í”¼ë“œ í‘œì‹œ
- âœ… ìƒˆë¡œìš´ ì •ë³´ ì»¨í…ì¸  ì‹œìŠ¤í…œ

ğŸ‰ ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•œë‹¤ë©´ ì´ ê¸€ì„ ë³´ì‹¤ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤!

---
ğŸ¤– Generated by Claude Code + Playwright Automation`,
    category: 'community'
  };

  try {
    console.log('ğŸš€ Claude AI ì™„ì „í•œ ì‚¬ìš©ì ì—¬ì • í…ŒìŠ¤íŠ¸ ì‹œì‘');
    console.log('ğŸ‘¤ í…ŒìŠ¤íŠ¸ ê³„ì •:', testUser.username, '/', testUser.email);
    
    // ========================================
    // STEP 1: ì‚¬ì´íŠ¸ ì ‘ì†
    // ========================================
    console.log('\nğŸ“ STEP 1: ì‚¬ì´íŠ¸ ì ‘ì†');
    await page.goto('https://newbeginning-seven.vercel.app/', { waitUntil: 'networkidle' });
    console.log('âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ì† ì™„ë£Œ');
    
    // ========================================
    // STEP 2: íšŒì›ê°€ì…
    // ========================================
    console.log('\nğŸ“ STEP 2: íšŒì›ê°€ì…');
    
    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
    await page.click('a[href="/login"], button:has-text("ë¡œê·¸ì¸")');
    console.log('âœ… ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™');
    
    // íšŒì›ê°€ì… íƒ­ í´ë¦­
    await page.click('button:has-text("íšŒì›ê°€ì…")');
    console.log('âœ… íšŒì›ê°€ì… íƒ­ ì„ íƒ');
    
    // í¼ ì‘ì„±
    await page.fill('input[name="username"]', testUser.username);
    await page.fill('input[name="email"]', testUser.email);
    await page.fill('input[name="password"]', testUser.password);
    console.log('âœ… íšŒì›ê°€ì… í¼ ì‘ì„± ì™„ë£Œ');
    
    // íšŒì›ê°€ì… ì œì¶œ
    await page.click('button[type="submit"]:has-text("íšŒì›ê°€ì…")');
    console.log('ğŸ”„ íšŒì›ê°€ì… ì œì¶œ');
    
    // ê²°ê³¼ ëŒ€ê¸° (ì„±ê³µ ë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€)
    await page.waitForTimeout(3000);
    
    // ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
    const signupError = await page.locator('.text-red-500').textContent();
    if (signupError) {
      console.log('âŒ íšŒì›ê°€ì… ì—ëŸ¬:', signupError);
      throw new Error(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${signupError}`);
    }
    
    // ì„±ê³µ ë©”ì‹œì§€ í™•ì¸
    const signupSuccess = await page.locator('text=íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤').count();
    if (signupSuccess > 0) {
      console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ!');
    }
    
    // ========================================
    // STEP 3: ë¡œê·¸ì¸
    // ========================================
    console.log('\nğŸ“ STEP 3: ë¡œê·¸ì¸');
    
    // ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
    await page.click('button:has-text("ë¡œê·¸ì¸")');
    await page.waitForTimeout(1000);
    console.log('âœ… ë¡œê·¸ì¸ íƒ­ ì„ íƒ');
    
    // ë¡œê·¸ì¸ í¼ ì‘ì„±
    await page.fill('input[name="email"]', testUser.email);
    await page.fill('input[name="password"]', testUser.password);
    console.log('âœ… ë¡œê·¸ì¸ í¼ ì‘ì„±');
    
    // ë¡œê·¸ì¸ ì œì¶œ
    await page.click('button[type="submit"]:has-text("ë¡œê·¸ì¸")');
    console.log('ğŸ”„ ë¡œê·¸ì¸ ì‹œë„');
    
    // ë¡œê·¸ì¸ ê²°ê³¼ í™•ì¸ (ì„±ê³µ ì‹œ ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸, ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€)
    await page.waitForTimeout(5000);
    
    const loginError = await page.locator('.text-red-500').textContent();
    if (loginError) {
      console.log('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', loginError);
      console.log('ğŸ” í˜„ì¬ URL:', page.url());
      
      // ë¡œê·¸ì¸ ì‹¤íŒ¨ ìŠ¤í¬ë¦°ìƒ·
      await page.screenshot({ path: 'login-failed.png', fullPage: true });
      throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${loginError}`);
    }
    
    // ë©”ì¸ í˜ì´ì§€ ë„ë‹¬ í™•ì¸
    const currentUrl = page.url();
    if (currentUrl === 'https://newbeginning-seven.vercel.app/' || currentUrl.includes('newbeginning-seven.vercel.app')) {
      console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ! ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨');
      console.log('ğŸ”— í˜„ì¬ URL:', currentUrl);
    }
    
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ê¸€ì“°ê¸° ë²„íŠ¼ ë˜ëŠ” ì‚¬ìš©ìëª… í™•ì¸)
    const isLoggedIn = await page.locator('text=ê¸€ì“°ê¸°, a[href="/write"]').count() > 0 ||
                       await page.locator(`text=${testUser.username}`).count() > 0;
    
    if (isLoggedIn) {
      console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨');
    } else {
      console.log('âš ï¸ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë¶ˆê°€');
    }
    
    // ========================================
    // STEP 4: ê¸€ ì‘ì„±
    // ========================================
    console.log('\nğŸ“ STEP 4: ê¸€ ì‘ì„±');
    
    // ê¸€ì“°ê¸° í˜ì´ì§€ë¡œ ì´ë™
    await page.goto('https://newbeginning-seven.vercel.app/write');
    console.log('âœ… ê¸€ì“°ê¸° í˜ì´ì§€ ì´ë™');
    
    // ê¸€ì“°ê¸° í¼ ëŒ€ê¸° ë° í™•ì¸
    try {
      await page.waitForSelector('input[name="title"]', { timeout: 10000 });
      console.log('âœ… ê¸€ì“°ê¸° í¼ ë¡œë“œë¨');
    } catch (e) {
      console.log('âŒ ê¸€ì“°ê¸° í¼ ë¡œë“œ ì‹¤íŒ¨ - ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±');
      await page.screenshot({ path: 'write-page-error.png' });
      throw new Error('ê¸€ì“°ê¸° í˜ì´ì§€ ì ‘ê·¼ ì‹¤íŒ¨');
    }
    
    // ê¸€ ì‘ì„±
    await page.fill('input[name="title"]', testPost.title);
    await page.fill('textarea[name="content"]', testPost.content);
    console.log('âœ… ê¸€ ë‚´ìš© ì‘ì„± ì™„ë£Œ');
    
    // ì¹´í…Œê³ ë¦¬ ì„ íƒ
    const categorySelect = await page.locator('select[name="category"]').first();
    if (await categorySelect.count() > 0) {
      await categorySelect.selectOption(testPost.category);
      console.log('âœ… ì¹´í…Œê³ ë¦¬ ì„ íƒ:', testPost.category);
    }
    
    // ê¸€ ë°œí–‰
    await page.click('button[type="submit"]');
    console.log('ğŸ”„ ê¸€ ë°œí–‰ ë²„íŠ¼ í´ë¦­');
    
    // ë°œí–‰ ê²°ê³¼ í™•ì¸
    await page.waitForTimeout(5000);
    const postUrl = page.url();
    console.log('ğŸ“ ê¸€ ë°œí–‰ í›„ URL:', postUrl);
    
    if (postUrl.includes('/post/')) {
      console.log('âœ… ê¸€ ë°œí–‰ ì„±ê³µ! ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ë¨');
      
      // ê¸€ ì œëª© í™•ì¸
      const postTitle = await page.locator('h1, h2, h3').first();
      if (await postTitle.count() > 0) {
        const title = await postTitle.textContent();
        console.log('ğŸ“ ë°œí–‰ëœ ê¸€ ì œëª©:', title);
      }
    }
    
    // ========================================
    // STEP 5: ë©”ì¸ í”¼ë“œì—ì„œ ê¸€ í™•ì¸
    // ========================================
    console.log('\nğŸ“ STEP 5: ë©”ì¸ í”¼ë“œì—ì„œ ê¸€ í™•ì¸');
    
    await page.goto('https://newbeginning-seven.vercel.app/');
    await page.waitForTimeout(3000);
    
    const myPostInFeed = await page.locator(`text=${testPost.title}`).count();
    if (myPostInFeed > 0) {
      console.log('âœ… ë©”ì¸ í”¼ë“œì—ì„œ ì‘ì„±í•œ ê¸€ í™•ì¸ë¨!');
    } else {
      console.log('âš ï¸ ë©”ì¸ í”¼ë“œì—ì„œ ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (í˜ì´ì§€ë„¤ì´ì…˜ ë“±ì˜ ì´ìœ ì¼ ìˆ˜ ìˆìŒ)');
    }
    
    // ========================================
    // STEP 6: ë¡œê·¸ì•„ì›ƒ
    // ========================================
    console.log('\nğŸ“ STEP 6: ë¡œê·¸ì•„ì›ƒ');
    
    // ì‚¬ìš©ì ë©”ë‰´ ì°¾ê¸° ë° í´ë¦­
    try {
      const userMenu = await page.locator('button:has-text("' + testUser.username + '"), [class*="group"] button').first();
      if (await userMenu.count() > 0) {
        await userMenu.hover(); // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì—´ê¸°
        await page.waitForTimeout(1000);
        
        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
        await page.click('button:has-text("ë¡œê·¸ì•„ì›ƒ"), text=ë¡œê·¸ì•„ì›ƒ');
        console.log('âœ… ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­');
        
        await page.waitForTimeout(3000);
        
        // ë¡œê·¸ì•„ì›ƒ í›„ ìƒíƒœ í™•ì¸
        const loggedOut = await page.locator('text=ë¡œê·¸ì¸, a[href="/login"]').count() > 0;
        if (loggedOut) {
          console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ! ë¡œê·¸ì¸ ë²„íŠ¼ ë‹¤ì‹œ ë‚˜íƒ€ë‚¨');
        }
      } else {
        console.log('âŒ ì‚¬ìš©ì ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }
    } catch (logoutError) {
      console.log('âš ï¸ ë¡œê·¸ì•„ì›ƒ ê³¼ì •ì—ì„œ ë¬¸ì œ:', logoutError.message);
    }
    
    // ========================================
    // FINAL: í…ŒìŠ¤íŠ¸ ì™„ë£Œ ë° ê²°ê³¼ ì •ë¦¬
    // ========================================
    console.log('\nğŸ¯ FINAL RESULTS:');
    console.log('=======================================');
    console.log(`âœ… í…ŒìŠ¤íŠ¸ ê³„ì •: ${testUser.username}`);
    console.log(`âœ… í…ŒìŠ¤íŠ¸ ê¸€: "${testPost.title}"`);
    console.log('âœ… íšŒì›ê°€ì… â†’ ë¡œê·¸ì¸ â†’ ê¸€ ì‘ì„± â†’ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
    console.log('=======================================');
    
    // ìµœì¢… ìŠ¤í¬ë¦°ìƒ·
    await page.screenshot({ path: 'complete-user-journey-final.png', fullPage: true });
    console.log('ğŸ“¸ ìµœì¢… í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦°ìƒ· ì €ì¥ë¨');
    
  } catch (error) {
    console.log('\nğŸ’¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!');
    console.log('=======================================');
    console.log('âŒ ì‹¤íŒ¨ ë‹¨ê³„:', error.message);
    console.log('ğŸ“ ì‹¤íŒ¨ ì‹œì  URL:', page.url());
    console.log('=======================================');
    
    // ì—ëŸ¬ ìƒí™© ìŠ¤í¬ë¦°ìƒ·
    try {
      await page.screenshot({ path: 'user-journey-failure.png', fullPage: true });
      console.log('ğŸ“¸ ì‹¤íŒ¨ ìƒí™© ìŠ¤í¬ë¦°ìƒ· ì €ì¥ë¨');
    } catch (e) {
      console.log('ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì‹¤íŒ¨');
    }
    
    // í˜ì´ì§€ ë‚´ ì—ëŸ¬ ë©”ì‹œì§€ë“¤ ìˆ˜ì§‘
    try {
      const allErrors = await page.locator('.text-red-500, [class*="error"], .error').allTextContents();
      if (allErrors.length > 0) {
        console.log('ğŸ” í˜ì´ì§€ ë‚´ ì—ëŸ¬ ë©”ì‹œì§€ë“¤:');
        allErrors.forEach((msg, idx) => {
          console.log(`   ${idx + 1}. ${msg}`);
        });
      }
    } catch (e) {
      console.log('ì—ëŸ¬ ë©”ì‹œì§€ ìˆ˜ì§‘ ì‹¤íŒ¨');
    }
    
    throw error;
  }
});